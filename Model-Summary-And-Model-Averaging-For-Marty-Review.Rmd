---
title: "Hakai-Lice-Models-Overview"
author: "Cole"
date: "August 20, 2019"
output:
  html_document:
    df_print: paged
---
#Preliminary Things

I thought this might be the easiest way to show you all the things without having to copy and paste everything into a word document, so here's an RMD instead lol. 

Necessary packages etc:

```{r, echo=FALSE}
#packages
library(tidyverse)
library(glmmTMB)
library(ggeffects)
library(DHARMa)
library(MuMIn)
library(cowplot)
library(AICcmodavg)
library(latexpdf)
library(MATA)

#data
mainlice <- read.csv("Hakai_lice_data_CB_edits.csv")

#make vars into factors
mainlice$year <- as.factor(mainlice$year);mainlice$collection <- as.factor(mainlice$collection)
```

#Initial Model Set 

The first set of models from this past school year (region removed from initial model and fit by itself)

## Species Level Models

```{r}
#models and dredge them
lepmodspecies.full <- glmmTMB(all.leps ~ spp + year - 1 + (1|collection), 
                         data = mainlice, family=nbinom2)
calmodspecies.full <- glmmTMB(all.cal ~ spp + year - 1 + (1|collection), 
                         data = mainlice, family=nbinom2)

lepmodspecies.full_dredge = MuMIn::dredge(lepmodspecies.full)
calmodspecies.full_dredge = MuMIn::dredge(calmodspecies.full)
lepmodspecies.full_dredge
calmodspecies.full_dredge

```

## Species Level Effects Plots

```{r}
#effects and plot them

calspecieseffects <- ggpredict(calmodspecies.full, terms = c('spp', 'year'))
lepspecieseffects <- ggpredict(lepmodspecies.full, terms = c('spp', 'year'))

lepspecieseffects = lepspecieseffects %>% 
  rename(sal = x, yr = group)

lepspecieseffects$sal = factor(lepspecieseffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

calspecieseffects = calspecieseffects %>% 
  rename(sal = x, yr = group)

calspecieseffects$sal = factor(calspecieseffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

leg_title <- 'Salmon Species'
lepspeciesfullmodplot <- lepspecieseffects %>% 
  group_by(., yr,sal) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), colour = 'Black')+
  geom_point(size = 4) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2')) +
  labs(title = "L. salmonis Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish')
lepspeciesfullmodplot
calspeciesfullmodplot <- calspecieseffects %>% 
  group_by(., yr,sal) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), colour = 'Black')+
  geom_point(size = 4) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "C. clemensi Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish')
calspeciesfullmodplot
``` 

## Region-Level Models

```{r}
#region-level models
regionlice <- read.csv('Hakai_lice_data_all_fish_CB_edits.csv')

#now lets do it between all three species, by making some sub-dfs first
regionlice$week <- as.factor(regionlice$week); regionlice$year <- as.factor(regionlice$year)
chum.region <- regionlice %>% 
  filter(spp == 'CU')
pink.region <- regionlice %>% 
  filter(spp == 'PI')
sock.region <- regionlice %>% 
  filter(spp == 'SO')

chumrmod.calnb <- glmmTMB(all.cal ~ site.region + year - 1 + (1|week), 
                           data = chum.region, family=nbinom2)
chumrmod.lepsnb <- glmmTMB(all.leps ~ site.region + year - 1 + (1|week), 
                          data = chum.region, family=nbinom2)
pinkrmod.calnb <- glmmTMB(all.cal ~ site.region + year - 1  + (1|week), 
                         data = pink.region, family=nbinom2)
pinkrmod.lepsnb <- glmmTMB(all.leps ~ site.region + year - 1 + (1|week), 
                          data = pink.region, family=nbinom2)
sockrmod.calnb <- glmmTMB(all.cal ~ site.region + year - 1 + (1|week), 
                         data = sock.region, family=nbinom2)
sockrmod.lepsnbsr <- glmmTMB(all.leps ~ site.region - 1 + (1|week), 
                            data = sock.region, family=nbinom2)
summary(chumrmod.calnb); summary(chumrmod.lepsnb); summary(pinkrmod.calnb); summary(pinkrmod.lepsnb); summary(sockrmod.calnb); summary(sockrmod.lepsnbsr)
```

## AIC tables

```{r}
chumcalspeffects <- ggpredict(chumrmod.calnb, terms = c('site.region', 'year'))
chumcalspeffects = chumcalspeffects %>%
  rename(site.region = x, yr = group) %>%
  mutate(lice = 'cal')
chumcalspeffects$site.region = factor(chumcalspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

chumlepspeffects <- ggpredict(chumrmod.lepsnb,terms = c('site.region', 'year'))
chumlepspeffects = chumlepspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'leps')
chumlepspeffects$site.region = factor(chumlepspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

pinkcalspeffects <- ggpredict(pinkrmod.calnb, terms = c('site.region', 'year'))
pinkcalspeffects = pinkcalspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'cal')
pinkcalspeffects$site.region = factor(pinkcalspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

pinklepspeffects <- ggpredict(pinkrmod.lepsnb,terms = c('site.region', 'year'))
pinklepspeffects = pinklepspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'leps')
pinklepspeffects$site.region = factor(pinklepspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

sockcalspeffects <- ggpredict(sockrmod.calnb, terms = c('site.region', 'year'))
sockcalspeffects = sockcalspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'cal')
sockcalspeffects$site.region = factor(sockcalspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

socklepspeffects <- ggpredict(sockrmod.lepsnbsr,terms = 'site.region')
socklepspeffects = socklepspeffects %>%
  rename(site.region = x)%>%
  mutate(lice = 'leps')
socklepspeffects$site.region = factor(socklepspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

chumeffects = rbind(chumcalspeffects, chumlepspeffects)
pinkeffects = rbind(pinkcalspeffects, pinklepspeffects)

```

## Region Level Effects Plots

```{r}
#make some themes so it all looks nice beside each other
fte_themeSock <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_text(size = 10, color = color.axis.text)) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(color="black", size = 0.15)) +
    theme(strip.background = element_blank(),
                  strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = 'none')
}
fte_themeSock2 <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_text(size = 10, color = color.axis.text)) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(color="black", size = 0.15)) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = c(0.9,0.82),
          legend.text = element_text(size = 10),
          legend.title = element_text(size = 10))
}
fte_themeSock3 <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_text(size = 10, color = color.axis.text)) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title,
                                      margin= margin(t = 0.7, r = , b = 0, l = 0, unit = "cm"), vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(color="black", size = 0.15)) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = 'none')
}
fte_themePink <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_blank()) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(linetype = 'dashed', color = 'grey75')) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = 'none')
}
fte_themeChum <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_blank()) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(linetype = 'dashed', color = 'grey75')) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = c(0.8,0.82),
          legend.text = element_text(size = 10),
          legend.title = element_text(size = 10))
}

#make the plots
regionestbyspplotchumnb <- chumeffects %>% 
  group_by(.,lice,site.region,yr) %>% 
  ggplot(aes(x=site.region, y = predicted, colour = site.region, shape = lice)) +
  scale_shape_manual(values = c(17,15),labels = c('C. clemensi','L. salmonis'))+
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high, width = 0), position = position_dodge(width = 0.8),colour = 'Black') +
  geom_point(size = 4, position = position_dodge(width=0.8)) +
  facet_wrap(~yr, nrow=1, strip.position = 'bottom')+
  scale_color_manual(values=c('grey60', 'grey20'))+
  labs(title = "Chum Salmon",x = '', y = NULL,shape = 'Lice Species', colour = 'Region')+
  guides(shape = guide_legend(override.aes = list(shape = c(24,22)), type = 'b'))+
  scale_y_continuous(limits = c(0,1.25)) +
  fte_themeChum()
regionestbyspplotchumnb
regionestbyspplotpinknb <- pinkeffects %>% 
  group_by(.,lice,site.region,yr) %>% 
  ggplot(aes(x=site.region, y = predicted, colour = site.region, shape = lice)) +
  scale_shape_manual(values = c(17,15),labels = c('C. clemensi','L. salmonis'))+
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high, width = 0), position = position_dodge(width = 0.8),colour = 'Black') +
  geom_point(size = 4, position = position_dodge(width=0.8)) +
  facet_wrap(~yr, nrow=1, strip.position = 'bottom')+
  theme(strip.background = element_blank(),strip.placement = 'outside') +
  scale_color_manual(values=c('grey60', 'grey20'))+
  labs(title = "Pink Salmon", x = 'Year & Region', y = NULL,shape = 'Lice Species')+
  guides(shape = guide_legend(override.aes = list(shape = c(24,22)), type = 'b'))+
  scale_y_continuous(limits = c(0,1.25)) +
  fte_themePink()
regionestbyspplotpinknb
regionestbyspplotsockcal <- sockcalspeffects %>% 
  group_by(.,lice,site.region,yr) %>% 
  ggplot(aes(x=site.region, y = predicted, colour = site.region, shape = lice)) +
  scale_shape_manual(values = c(17,15),labels = c('C. clemensi','L. salmonis'))+
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high, width = 0), position = position_dodge(width = 0.8),colour = 'Black') +
  geom_point(size = 4, position = position_dodge(width=0.8)) +
  facet_wrap(~yr, nrow=1, strip.position = 'bottom')+
  theme(strip.background = element_blank(),strip.placement = 'outside') +
  scale_color_manual(values=c('grey60', 'grey20'))+
  labs(title = "Sockeye Salmon", x = '', y = 'Average Number of Motile Lice Per Fish',shape = 'Lice Species')+
  guides(shape = guide_legend(override.aes = list(shape = c(24,22)), type = 'b'))+
  scale_y_continuous(limits = c(0,1.25))+
  fte_themeSock()
regionestbyspplotsockcal

regionbothcalsock <- plot_grid(regionestbyspplotsockcal,regionestbyspplotpinknb,regionestbyspplotchumnb,
                          nrow = 1, labels = NULL, rel_widths = c(1,1,1)) 
regionbothcalsock
```

# New Set of Models

## Models (No Crossed Effects)

```{r}
lepmod.yrsrsp <- glmmTMB(all.leps ~ spp + site.region + year - 1 + (1|collection), 
                      data = mainlice, family=nbinom2)
calmod.yrsrsp <- glmmTMB(all.cal ~ spp + site.region + year - 1 + (1|collection), 
                      data = mainlice, family=nbinom2)
```

## AIC tables

```{r}
lepmod.yrsrsp_dredge = MuMIn::dredge(lepmod.yrsrsp)
calmod.yrsrsp_dredge = MuMIn::dredge(calmod.yrsrsp)
lepmod.yrsrsp_dredge
calmod.yrsrsp_dredge
```

## Effects Plots

```{r}
calspeffects <- ggpredict(calmod.yrsrsp, terms = c('spp', 'year', 'site.region'))
lepspeffects <- ggpredict(lepmod.yrsrsp, terms = c('spp', 'year', 'site.region'))

calspeffects = calspeffects %>% 
  rename(sal = x, reg = facet, yr = group)

calspeffects$sal = factor(calspeffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

lepspeffects = lepspeffects %>% 
  rename(sal = x, reg = facet, yr = group)

lepspeffects$sal = factor(lepspeffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

## Make the plots

leg_title <- 'Salmon Species'
leps3fullmodplot <- lepspeffects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "L. salmonis Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
leps3fullmodplot
cal3fullmodplot <- calspeffects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "C. clemensi Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
cal3fullmodplot
```

## Models (Crossed Effects)

```{r}
lepmod.crossed <- glmmTMB(all.leps ~ spp * site.region + spp * year + 
                            site.region * year + (1 | collection), 
                          data = mainlice, family=nbinom2)
calmod.crossed <- glmmTMB(all.cal ~ spp * site.region + spp * year + 
                            site.region * year + (1 | collection), 
                          data = mainlice, family=nbinom2)
```

## AIC Tables

```{r}
lepmod.crossed_dredge = MuMIn::dredge(lepmod.crossed, subset = (`cond(site.region)` && `cond(year)`))
lepmod.crossed_dredge
calmod.crossed_dredge = MuMIn::dredge(calmod.crossed, subset = (`cond(site.region)` && `cond(year)`))
calmod.crossed_dredge
```

## Effects Plots

```{r}
lepmod.crossed.top <- glmmTMB(all.leps ~ spp + site.region + year + site.region * year - 1 + (1 | collection), 
                      data = mainlice, family=nbinom2)
summary(lepmod.crossed.top)
calmod.crossed.top <- glmmTMB(all.cal ~ year + site.region + spp + spp * site.region + 
                            site.region * year + (1 | collection), 
                          data = mainlice, family=nbinom2)
summary(calmod.crossed.top)

lep_top_effects <- ggpredict(lepmod.crossed.top, terms = c('spp', 'year', 'site.region')) #not sure if I did this right
cal_top_effects <- ggpredict(calmod.crossed.top, terms = c('spp', 'year', 'site.region'))

lep_top_effects = lep_top_effects %>% 
  rename(sal = x, reg = facet, yr = group)
cal_top_effects = cal_top_effects %>% 
  rename(sal = x, reg = facet, yr = group)

lep_top_effects$sal = factor(lep_top_effects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))
cal_top_effects$sal = factor(cal_top_effects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

## Make the plots

leg_title <- 'Salmon Species'
lepsfullmodplot_top <- lep_top_effects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "L. salmonis Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
lepsfullmodplot_top
calfullmodplot_top <- cal_top_effects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "C. clemensi Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
calfullmodplot_top

```

# Model Averaging

So the goal here is to hard code all of this, starting with the model-averaged predictions and then the confidence intervals. 

For the predictions, we have the set of $R$ candidate models ${M_1,...,M_n}$ models and we want the model-averaged estimator $\hat{theta}$ of $\theta$ as the weighted average from each model$$\hat{theta} = \sum_{i=1}^R \w_i\hat{theta}$$. This can be used to average the predictions that we get using the ggpredict package. 

First we need all our candidate models - for simplicity sake they've been organized by the ranking from the model comparison. 

```{r}
#omited the last two models in each set since their weights were 0. 
lep1 = glmmTMB(all.leps ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep2 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep3 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep4 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep5 = glmmTMB(all.leps ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep6 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year +  
            (1 | collection), data = mainlice, family = nbinom2) 
lep7 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep8 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2) 



cal1 = glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year + site.region * spp +
            (1 | collection), data = mainlice, family = nbinom2) 
cal2 = glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal3 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + site.region * year + spp * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal4 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2)
cal5 = glmmTMB(all.cal ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal6 = glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year +  
            (1 | collection), data = mainlice, family = nbinom2)
cal7 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal8 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2) 
summary(cal1)
```

Now let's use the ggpredict package to get predictions:

```{r}
lep1pred <- ggpredict(lep1, terms = c('spp', 'year', 'site.region'))
lep2pred <- ggpredict(lep2, terms = c('spp', 'year', 'site.region')) 
lep3pred <- ggpredict(lep3, terms = c('spp', 'year', 'site.region')) 
lep4pred <- ggpredict(lep4, terms = c('spp', 'year', 'site.region')) 
lep5pred <- ggpredict(lep5, terms = c('spp', 'year', 'site.region')) 
lep6pred <- ggpredict(lep6, terms = c('spp', 'year', 'site.region')) 
lep7pred <- ggpredict(lep7, terms = c('spp', 'year', 'site.region')) 
lep8pred <- ggpredict(lep8, terms = c('spp', 'year', 'site.region')) 

cal1pred <- ggpredict(cal1, terms = c('spp', 'year', 'site.region'))
cal2pred <- ggpredict(cal2, terms = c('spp', 'year', 'site.region')) 
cal3pred <- ggpredict(cal3, terms = c('spp', 'year', 'site.region')) 
cal4pred <- ggpredict(cal4, terms = c('spp', 'year', 'site.region')) 
cal5pred <- ggpredict(cal5, terms = c('spp', 'year', 'site.region')) 
cal6pred <- ggpredict(cal6, terms = c('spp', 'year', 'site.region')) 
cal7pred <- ggpredict(cal7, terms = c('spp', 'year', 'site.region')) 
cal8pred <- ggpredict(cal8, terms = c('spp', 'year', 'site.region')) 

```

So now that we have the predictions, we can use the weights to get model averaged results for each. 

```{r}
###start by getting them all in one dataframe with the weights

#pull the predicted values from each one
lepallpred = data.frame(cbind(lep1pred$predicted, lep2pred$predicted, lep3pred$predicted, lep4pred$predicted,
                   lep5pred$predicted, lep6pred$predicted, lep7pred$predicted, lep8pred$predicted)) %>% 
                  rename(lep1 = X1, lep2 = X2, lep3 = X3, lep4 = X4, lep5 = X5, lep6 = X6, lep7 = X7, lep8 = X8)
calallpred = data.frame(cbind(cal1pred$predicted, cal2pred$predicted, cal3pred$predicted, cal4pred$predicted,
                   cal5pred$predicted, cal6pred$predicted, cal7pred$predicted, cal8pred$predicted)) %>% 
                  rename(cal1 = X1, cal2 = X2, cal3 = X3, cal4 = X4, cal5 = X5, cal6 = X6, cal7 = X7, cal8 = X8)

#add the weights from the model selection object
lepallpred = lepallpred %>% 
  mutate(w1 = rep(lepmod.crossed_dredge$weight[1], nrow(lepallpred)), 
         w2 = rep(lepmod.crossed_dredge$weight[2], nrow(lepallpred)),
         w3 = rep(lepmod.crossed_dredge$weight[3], nrow(lepallpred)),
         w4 = rep(lepmod.crossed_dredge$weight[4], nrow(lepallpred)),
         w5 = rep(lepmod.crossed_dredge$weight[5], nrow(lepallpred)),
         w6 = rep(lepmod.crossed_dredge$weight[6], nrow(lepallpred)),
         w7 = rep(lepmod.crossed_dredge$weight[7], nrow(lepallpred)),
         w8 = rep(lepmod.crossed_dredge$weight[8], nrow(lepallpred)))

calallpred = calallpred %>% 
  mutate(w1 = rep(calmod.crossed_dredge$weight[1], nrow(calallpred)), 
         w2 = rep(calmod.crossed_dredge$weight[2], nrow(calallpred)),
         w3 = rep(calmod.crossed_dredge$weight[3], nrow(calallpred)),
         w4 = rep(calmod.crossed_dredge$weight[4], nrow(calallpred)),
         w5 = rep(calmod.crossed_dredge$weight[5], nrow(calallpred)),
         w6 = rep(calmod.crossed_dredge$weight[6], nrow(calallpred)),
         w7 = rep(calmod.crossed_dredge$weight[7], nrow(calallpred)),
         w8 = rep(calmod.crossed_dredge$weight[8], nrow(calallpred)))

#now make averaged predictions!
lepallpred = lepallpred %>% 
  mutate(lep1w = lep1*w1, lep2w = lep2*w2, lep3w = lep3*w3, lep4w = lep4*w4, lep5w = lep5*w5, lep6w = lep6*w6, lep7w = lep7*w7, lep8w = lep8*w8) %>% 
  mutate(avg = lep1w + lep2w + lep3w + lep4w + lep5w + lep6w + lep7w + lep8w)

calallpred = calallpred %>% 
  mutate(cal1w = cal1*w1, cal2w = cal2*w2, cal3w = cal3*w3, cal4w = cal4*w4, cal5w = cal5*w5, cal6w = cal6*w6, cal7w = cal7*w7, cal8w = cal8*w8) %>% 
  mutate(avg = cal1w + cal2w + cal3w + cal4w + cal5w + cal6w + cal7w + cal8w)

#keep just the averaged predictions and the relevant grouping info 
lepavgpred = lepallpred %>% 
  select(avg) %>% 
  mutate(sal = lep1pred$x, reg = lep1pred$facet, yr = lep1pred$group)
lepavgpred$sal = factor(lepavgpred$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

calavgpred = calallpred %>% 
  select(avg) %>% 
  mutate(sal = cal1pred$x, reg = cal1pred$facet, yr = cal1pred$group)
calavgpred$sal = factor(calavgpred$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))
```

So now we have to come up with a way to get a model-averaged confidence interval. There are a few reasons this is not possible with existing methods. In order to use the predict() function and MuMIn to get model-averaged predictions we need to use the glmer function (because the re.form argument hasn't been developed for glmmTMB yet and we need to use that to allow predict to work without taking into account the random effects), but the glmer function won't fit our models so we need to use glmmTMB. 

As such, we need to manually calculate the model-averaged confidence interval. To do so, we borrow from Burnham & Anderson (2002), and use a heuristic argument regarding Bayesian model averaging to come up with an estimate for the unconditional variance: $$var(\hat{theta}) = \sum_{i=1}^R [var(\hat{theta_i}) + (\hat{theta_i}-\hat{theta})^2].$$ This can subsequently used to calculate a model averaged Wald interval: $\hat{theta} \pm (\z_alpha)var(\hat{theta}^1/2$. where $(\z_alpha)$ is the $(1-(\alpha))$ quantile of the standard normal distribution. 

```{r}
############################################## Leps
# relationship between variance and standard error
#interval = thetahat +- z*var(thetahat)^1/2
#where z is (1-alpha) -> if alpha is 0.05, z = 0.95
####so we need to do this for all the predictions
n = 1835
# 1
thetahatsIleps =c(lep1pred$predicted[1], lep2pred$predicted[1], lep3pred$predicted[1], lep4pred$predicted[1], 
                  lep5pred$predicted[1], lep6pred$predicted[1], lep7pred$predicted[1], lep8pred$predicted[1])
sethetahatsleps=c(lep1pred$std.error[1], lep2pred$std.error[1], lep3pred$std.error[1], lep4pred$std.error[1], 
                  lep5pred$std.error[1], lep6pred$std.error[1], lep7pred$std.error[1], lep8pred$std.error[1])
thetahat = lepallpred$avg[1]
model.weights = modelweightsleps[c(1:8)]


varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[1] = (thetahat - (0.95*varx)^1/2)
lepallpred$conf.high[1] = (thetahat + (0.05*varx^1/2))

# 2
thetahatsIleps =c(lep1pred$predicted[2], lep2pred$predicted[2], lep3pred$predicted[2], lep4pred$predicted[2], 
                  lep5pred$predicted[2], lep6pred$predicted[2], lep7pred$predicted[2], lep8pred$predicted[2])
sethetahatsleps=c(lep1pred$std.error[2], lep2pred$std.error[2], lep3pred$std.error[2], lep4pred$std.error[2], 
                  lep5pred$std.error[2], lep6pred$std.error[2], lep7pred$std.error[2], lep8pred$std.error[2])
thetahat = lepallpred$avg[2]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[2] = (thetahat - (0.025*varx^1/2))
lepallpred$conf.high[2] = (thetahat + (0.05*varx^1/2))

# 3333
thetahatsIleps =c(lep1pred$predicted[3], lep2pred$predicted[3], lep3pred$predicted[3], lep4pred$predicted[3], 
                  lep5pred$predicted[3], lep6pred$predicted[3], lep7pred$predicted[3], lep8pred$predicted[3])
sethetahatsleps=c(lep1pred$std.error[3], lep2pred$std.error[3], lep3pred$std.error[3], lep4pred$std.error[3], 
                  lep5pred$std.error[3], lep6pred$std.error[3], lep7pred$std.error[3], lep8pred$std.error[3])
thetahat = lepallpred$avg[3]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[3] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[3] = (thetahat + (0.05*varx^1/2))

# 4444
thetahatsIleps =c(lep1pred$predicted[4], lep2pred$predicted[4], lep3pred$predicted[4], lep4pred$predicted[4], 
                  lep5pred$predicted[4], lep6pred$predicted[4], lep7pred$predicted[4], lep8pred$predicted[4])
sethetahatsleps=c(lep1pred$std.error[4], lep2pred$std.error[4], lep3pred$std.error[4], lep4pred$std.error[4], 
                  lep5pred$std.error[4], lep6pred$std.error[4], lep7pred$std.error[4], lep8pred$std.error[4])
thetahat = lepallpred$avg[4]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[4] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[4] = (thetahat + (0.05*varx^1/2))

# 55555
thetahatsIleps =c(lep1pred$predicted[5], lep2pred$predicted[5], lep3pred$predicted[5], lep4pred$predicted[5], 
                  lep5pred$predicted[5], lep6pred$predicted[5], lep7pred$predicted[5], lep8pred$predicted[5])
sethetahatsleps=c(lep1pred$std.error[5], lep2pred$std.error[5], lep3pred$std.error[5], lep4pred$std.error[5], 
                  lep5pred$std.error[5], lep6pred$std.error[5], lep7pred$std.error[5], lep8pred$std.error[5])
thetahat = lepallpred$avg[5]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[5] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[5] = (thetahat + (0.05*varx^1/2))

# 66666
thetahatsIleps =c(lep1pred$predicted[6], lep2pred$predicted[6], lep3pred$predicted[6], lep4pred$predicted[6], 
                  lep5pred$predicted[6], lep6pred$predicted[6], lep7pred$predicted[6], lep8pred$predicted[6])
sethetahatsleps=c(lep1pred$std.error[6], lep2pred$std.error[6], lep3pred$std.error[6], lep4pred$std.error[6], 
                  lep5pred$std.error[6], lep6pred$std.error[6], lep7pred$std.error[6], lep8pred$std.error[6])
thetahat = lepallpred$avg[6]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[6] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[6] = (thetahat + (0.05*varx^1/2))

# 777
thetahatsIleps =c(lep1pred$predicted[7], lep2pred$predicted[7], lep3pred$predicted[7], lep4pred$predicted[7], 
                  lep5pred$predicted[7], lep6pred$predicted[7], lep7pred$predicted[7], lep8pred$predicted[7])
sethetahatsleps=c(lep1pred$std.error[7], lep2pred$std.error[7], lep3pred$std.error[7], lep4pred$std.error[7], 
                  lep5pred$std.error[7], lep6pred$std.error[7], lep7pred$std.error[7], lep8pred$std.error[7])
thetahat = lepallpred$avg[7]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[7] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[7] = (thetahat + (0.05*varx^1/2))

# 8888
thetahatsIleps =c(lep1pred$predicted[8], lep2pred$predicted[8], lep3pred$predicted[8], lep4pred$predicted[8], 
                  lep5pred$predicted[8], lep6pred$predicted[8], lep7pred$predicted[8], lep8pred$predicted[8])
sethetahatsleps=c(lep1pred$std.error[8], lep2pred$std.error[8], lep3pred$std.error[8], lep4pred$std.error[8], 
                  lep5pred$std.error[8], lep6pred$std.error[8], lep7pred$std.error[8], lep8pred$std.error[8])
thetahat = lepallpred$avg[8]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[8] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[8] = (thetahat + (0.05*varx^1/2))

# 9999
thetahatsIleps =c(lep1pred$predicted[9], lep2pred$predicted[9], lep3pred$predicted[9], lep4pred$predicted[9], 
                  lep5pred$predicted[9], lep6pred$predicted[9], lep7pred$predicted[9], lep8pred$predicted[9])
sethetahatsleps=c(lep1pred$std.error[9], lep2pred$std.error[9], lep3pred$std.error[9], lep4pred$std.error[9], 
                  lep5pred$std.error[9], lep6pred$std.error[9], lep7pred$std.error[9], lep8pred$std.error[9])
thetahat = lepallpred$avg[9]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[9] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[9] = (thetahat + (0.05*varx^1/2))

# 10
thetahatsIleps =c(lep1pred$predicted[10], lep2pred$predicted[10], lep3pred$predicted[10], lep4pred$predicted[10], 
                  lep5pred$predicted[10], lep6pred$predicted[10], lep7pred$predicted[10], lep8pred$predicted[10])
sethetahatsleps=c(lep1pred$std.error[10], lep2pred$std.error[10], lep3pred$std.error[10], lep4pred$std.error[10], 
                  lep5pred$std.error[10], lep6pred$std.error[10], lep7pred$std.error[10], lep8pred$std.error[10])
thetahat = lepallpred$avg[10]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[10] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[10] = (thetahat + (0.05*varx^1/2))

# 11
thetahatsIleps =c(lep1pred$predicted[11], lep2pred$predicted[11], lep3pred$predicted[11], lep4pred$predicted[11], 
                  lep5pred$predicted[11], lep6pred$predicted[11], lep7pred$predicted[11], lep8pred$predicted[11])
sethetahatsleps=c(lep1pred$std.error[11], lep2pred$std.error[11], lep3pred$std.error[11], lep4pred$std.error[11], 
                  lep5pred$std.error[11], lep6pred$std.error[11], lep7pred$std.error[11], lep8pred$std.error[11])
thetahat = lepallpred$avg[11]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[11] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[11] = (thetahat + (0.05*varx^1/2))

# 122222
thetahatsIleps =c(lep1pred$predicted[12], lep2pred$predicted[12], lep3pred$predicted[12], lep4pred$predicted[12], 
                  lep5pred$predicted[12], lep6pred$predicted[12], lep7pred$predicted[12], lep8pred$predicted[12])
sethetahatsleps=c(lep1pred$std.error[12], lep2pred$std.error[12], lep3pred$std.error[12], lep4pred$std.error[12], 
                  lep5pred$std.error[12], lep6pred$std.error[12], lep7pred$std.error[12], lep8pred$std.error[12])
thetahat = lepallpred$avg[12]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[12] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[12] = (thetahat + (0.05*varx^1/2))

# 133
thetahatsIleps =c(lep1pred$predicted[13], lep2pred$predicted[13], lep3pred$predicted[13], lep4pred$predicted[13], 
                  lep5pred$predicted[13], lep6pred$predicted[13], lep7pred$predicted[13], lep8pred$predicted[13])
sethetahatsleps=c(lep1pred$std.error[13], lep2pred$std.error[13], lep3pred$std.error[13], lep4pred$std.error[13], 
                  lep5pred$std.error[13], lep6pred$std.error[13], lep7pred$std.error[13], lep8pred$std.error[13])
thetahat = lepallpred$avg[13]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[13] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[13] = (thetahat + (0.05*varx^1/2))

# 14]44
thetahatsIleps =c(lep1pred$predicted[14], lep2pred$predicted[14], lep3pred$predicted[14], lep4pred$predicted[14], 
                  lep5pred$predicted[14], lep6pred$predicted[14], lep7pred$predicted[14], lep8pred$predicted[14])
sethetahatsleps=c(lep1pred$std.error[14], lep2pred$std.error[14], lep3pred$std.error[14], lep4pred$std.error[14], 
                  lep5pred$std.error[14], lep6pred$std.error[14], lep7pred$std.error[14], lep8pred$std.error[14])
thetahat = lepallpred$avg[14]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[14] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[14] = (thetahat + (0.05*varx^1/2))

# 15555
thetahatsIleps =c(lep1pred$predicted[15], lep2pred$predicted[15], lep3pred$predicted[15], lep4pred$predicted[15], 
                  lep5pred$predicted[15], lep6pred$predicted[15], lep7pred$predicted[15], lep8pred$predicted[15])
sethetahatsleps=c(lep1pred$std.error[15], lep2pred$std.error[15], lep3pred$std.error[15], lep4pred$std.error[15], 
                  lep5pred$std.error[15], lep6pred$std.error[15], lep7pred$std.error[15], lep8pred$std.error[15])
thetahat = lepallpred$avg[15]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[15] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[15] = (thetahat + (0.05*varx^1/2))

# 166
thetahatsIleps =c(lep1pred$predicted[16], lep2pred$predicted[16], lep3pred$predicted[16], lep4pred$predicted[16], 
                  lep5pred$predicted[16], lep6pred$predicted[16], lep7pred$predicted[16], lep8pred$predicted[16])
sethetahatsleps=c(lep1pred$std.error[16], lep2pred$std.error[16], lep3pred$std.error[16], lep4pred$std.error[16], 
                  lep5pred$std.error[16], lep6pred$std.error[16], lep7pred$std.error[16], lep8pred$std.error[16])
thetahat = lepallpred$avg[16]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[16] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[16] = (thetahat + (0.05*varx^1/2))

# 177
thetahatsIleps =c(lep1pred$predicted[17], lep2pred$predicted[17], lep3pred$predicted[17], lep4pred$predicted[17], 
                  lep5pred$predicted[17], lep6pred$predicted[17], lep7pred$predicted[17], lep8pred$predicted[17])
sethetahatsleps=c(lep1pred$std.error[17], lep2pred$std.error[17], lep3pred$std.error[17], lep4pred$std.error[17], 
                  lep5pred$std.error[17], lep6pred$std.error[17], lep7pred$std.error[17], lep8pred$std.error[17])
thetahat = lepallpred$avg[17]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[17] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[17] = (thetahat + (0.05*varx^1/2))

# 188888
thetahatsIleps =c(lep1pred$predicted[18], lep2pred$predicted[18], lep3pred$predicted[18], lep4pred$predicted[18], 
                  lep5pred$predicted[18], lep6pred$predicted[18], lep7pred$predicted[18], lep8pred$predicted[18])
sethetahatsleps=c(lep1pred$std.error[18], lep2pred$std.error[18], lep3pred$std.error[18], lep4pred$std.error[18], 
                  lep5pred$std.error[18], lep6pred$std.error[18], lep7pred$std.error[18], lep8pred$std.error[18])
thetahat = lepallpred$avg[18]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[18] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[18] = (thetahat + (0.05*varx^1/2))

# 199
thetahatsIleps =c(lep1pred$predicted[19], lep2pred$predicted[19], lep3pred$predicted[19], lep4pred$predicted[19], 
                  lep5pred$predicted[19], lep6pred$predicted[19], lep7pred$predicted[19], lep8pred$predicted[19])
sethetahatsleps=c(lep1pred$std.error[19], lep2pred$std.error[19], lep3pred$std.error[19], lep4pred$std.error[19], 
                  lep5pred$std.error[19], lep6pred$std.error[19], lep7pred$std.error[19], lep8pred$std.error[19])
thetahat = lepallpred$avg[19]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[19] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[19] = (thetahat + (0.05*varx^1/2))

# 2020202020
thetahatsIleps =c(lep1pred$predicted[20], lep2pred$predicted[20], lep3pred$predicted[20], lep4pred$predicted[20], 
                  lep5pred$predicted[20], lep6pred$predicted[20], lep7pred$predicted[20], lep8pred$predicted[20])
sethetahatsleps=c(lep1pred$std.error[20], lep2pred$std.error[20], lep3pred$std.error[20], lep4pred$std.error[20], 
                  lep5pred$std.error[20], lep6pred$std.error[20], lep7pred$std.error[20], lep8pred$std.error[20])
thetahat = lepallpred$avg[20]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[20] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[20] = (thetahat + (0.05*varx^1/2))

# 212
thetahatsIleps =c(lep1pred$predicted[21], lep2pred$predicted[21], lep3pred$predicted[21], lep4pred$predicted[21], 
                  lep5pred$predicted[21], lep6pred$predicted[21], lep7pred$predicted[21], lep8pred$predicted[21])
sethetahatsleps=c(lep1pred$std.error[21], lep2pred$std.error[21], lep3pred$std.error[21], lep4pred$std.error[21], 
                  lep5pred$std.error[21], lep6pred$std.error[21], lep7pred$std.error[21], lep8pred$std.error[21])
thetahat = lepallpred$avg[21]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[21] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[21] = (thetahat + (0.05*varx^1/2))

# 2222222222
thetahatsIleps =c(lep1pred$predicted[22], lep2pred$predicted[22], lep3pred$predicted[22], lep4pred$predicted[22], 
                  lep5pred$predicted[22], lep6pred$predicted[22], lep7pred$predicted[22], lep8pred$predicted[22])
sethetahatsleps=c(lep1pred$std.error[22], lep2pred$std.error[22], lep3pred$std.error[22], lep4pred$std.error[22], 
                  lep5pred$std.error[22], lep6pred$std.error[22], lep7pred$std.error[22], lep8pred$std.error[22])
thetahat = lepallpred$avg[22]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[22] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[22] = (thetahat + (0.05*varx^1/2))

# 2323232323
thetahatsIleps =c(lep1pred$predicted[23], lep2pred$predicted[23], lep3pred$predicted[23], lep4pred$predicted[23], 
                  lep5pred$predicted[23], lep6pred$predicted[23], lep7pred$predicted[23], lep8pred$predicted[23])
sethetahatsleps=c(lep1pred$std.error[23], lep2pred$std.error[23], lep3pred$std.error[23], lep4pred$std.error[23], 
                  lep5pred$std.error[23], lep6pred$std.error[23], lep7pred$std.error[23], lep8pred$std.error[23])
thetahat = lepallpred$avg[23]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[23] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[23] = (thetahat + (0.05*varx^1/2))

# 24242424
thetahatsIleps =c(lep1pred$predicted[24], lep2pred$predicted[24], lep3pred$predicted[24], lep4pred$predicted[24], 
                  lep5pred$predicted[24], lep6pred$predicted[24], lep7pred$predicted[24], lep8pred$predicted[24])
sethetahatsleps=c(lep1pred$std.error[24], lep2pred$std.error[24], lep3pred$std.error[24], lep4pred$std.error[24], 
                  lep5pred$std.error[24], lep6pred$std.error[24], lep7pred$std.error[24], lep8pred$std.error[24])
thetahat = lepallpred$avg[24]
model.weights = modelweightsleps[c(1:8)]

varx = sum((model.weights[1]*(((sethetahatsleps[1])^2)*(n)+((thetahatsIleps[1]-thetahat)^2))),
           (model.weights[2]*(((sethetahatsleps[2])^2)*(n)+((thetahatsIleps[2]-thetahat)^2))),
           (model.weights[3]*(((sethetahatsleps[3])^2)*(n)+((thetahatsIleps[3]-thetahat)^2))),
           (model.weights[4]*(((sethetahatsleps[4])^2)*(n)+((thetahatsIleps[4]-thetahat)^2))),
           (model.weights[5]*(((sethetahatsleps[5])^2)*(n)+((thetahatsIleps[5]-thetahat)^2))),
           (model.weights[6]*(((sethetahatsleps[6])^2)*(n)+((thetahatsIleps[6]-thetahat)^2))),
           (model.weights[7]*(((sethetahatsleps[7])^2)*(n)+((thetahatsIleps[7]-thetahat)^2))),
           (model.weights[8]*(((sethetahatsleps[8])^2)*(n)+((thetahatsIleps[8]-thetahat)^2))))
lepallpred$conf.low[24] = (thetahat - (0.05*varx^1/2))
lepallpred$conf.high[24] = (thetahat + (0.05*varx^1/2))

```

```{r}

aic = lepmod.crossed_dredge$AICc[1:8]
delta.aic = aic - min(aic)
model.weights = exp(-0.5*delta.aic)/sum(exp(-0.5*delta.aic))
newdata=list(sal=factor(1), year = factor(2015),site.region = 'DI')
p1 = predict(lep1, se = TRUE,re.form = ~0, newdata = newdata[1])
p2 = predict(lep2, se = TRUE)
theta.hats = c(p1$fit, p2$fit)
setheta.hats = c(p1$se.fit, p2$se.fit)
mata.wald(theta.hats=theta.hats, se.theta.hats=setheta.hats,
model.weights=model.werights, mata.t=FALSE)
length(theta.hats)


thetahatsleps = c(lep1pred$predicted[1], lep2pred$predicted[1], lep3pred$predicted[1], lep4pred$predicted[1], 
                  lep5pred$predicted[1], lep6pred$predicted[1], lep7pred$predicted[1], lep8pred$predicted[1])
sethetahatsleps=c(lep1pred$std.error[1], lep2pred$std.error[1], lep3pred$std.error[1], lep4pred$std.error[1], 
                  lep5pred$std.error[1], lep6pred$std.error[1], lep7pred$std.error[1], lep8pred$std.error[1])
#run the function
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)

x1 = as.factor(c(rep(0,n/2), rep(1,n/2))) # two groups: x1=0, and x1=1
x2 = rnorm(n, mean=10, sd=3)
x3 = as.factor(c(rep('A',n/2), rep('B',n/2)))
m1 = glm(y ~ x1)
m2 = glm(y ~ x1 + x2) # using 'lm' doesn't.
m3 = glm(y ~ x1*x2)
aic = c(m1$aic, m2$aic, m3$aic)
delta.aic = aic - min(aic)
model.weights = exp(-0.5*delta.aic) / sum(exp(-0.5*delta.aic))
residual.dfs = c(m1$df.residual, m2$df.residual)
p1 = predict(m1, se=TRUE, newdata=list(x1=factor(1), x2=15))
p2 = predict(m2, se=TRUE, newdata=list(x1=factor(1), x2=15))
p3 = predict(m3, se=TRUE, newdata=list(x1=factor(1), x2=15))

theta.hats = c(p1$fit, p2$fit, p3$fit)
se.theta.hats = c(p1$se.fit, p2$se.fit, p3$se.fit)
length(theta.hats)

mata.wald(theta.hats=theta.hats, se.theta.hats=se.theta.hats,
model.weights=model.weights, mata.t=FALSE)
m1p = ggpredict(m1)
m1p = data.frame(m1p)
theta.hats[1] + c(-1,1)*qt(0.975, residual.dfs[1])*se.theta.hats[1]





#first get the model weights
modelweightsleps = lepmod.crossed_dredge$weight
residualsleps = lepmod.crossed_dredge$df

##fitted value 1
#get the theta hats for the first prediction and the SE of theta hat
thetahatsleps = c(lep1pred$predicted[1], lep2pred$predicted[1], lep3pred$predicted[1], lep4pred$predicted[1], 
                  lep5pred$predicted[1], lep6pred$predicted[1], lep7pred$predicted[1], lep8pred$predicted[1])
sethetahatsleps=c(lep1pred$std.error[1], lep2pred$std.error[1], lep3pred$std.error[1], lep4pred$std.error[1], 
                  lep5pred$std.error[1], lep6pred$std.error[1], lep7pred$std.error[1], lep8pred$std.error[1])
length(sethetahatsleps)
#run the function
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
#put the values into the big dataframe
lepallpred$conf.low[1] = lepsCI1[1]; lepallpred$conf.high[1] = lepsCI1[2]

##fitted value 2
thetahatsleps = c(lep1pred$predicted[2], lep2pred$predicted[2], lep3pred$predicted[2], lep4pred$predicted[2], 
                  lep5pred$predicted[2], lep6pred$predicted[2], lep7pred$predicted[2], lep8pred$predicted[2])
sethetahatsleps=c(lep1pred$std.error[2], lep2pred$std.error[2], lep3pred$std.error[2], lep4pred$std.error[2], 
                  lep5pred$std.error[2], lep6pred$std.error[2], lep7pred$std.error[2], lep8pred$std.error[2])
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
lepallpred$conf.low[2] = lepsCI1[1]; lepallpred$conf.high[2] = lepsCI1[2]

##fitted value 3
thetahatsleps = c(lep1pred$predicted[3], lep2pred$predicted[3], lep3pred$predicted[3], lep4pred$predicted[3], 
                  lep5pred$predicted[3], lep6pred$predicted[3], lep7pred$predicted[3], lep8pred$predicted[3])
sethetahatsleps=c(lep1pred$std.error[3], lep2pred$std.error[3], lep3pred$std.error[3], lep4pred$std.error[3], 
                  lep5pred$std.error[3], lep6pred$std.error[3], lep7pred$std.error[3], lep8pred$std.error[3])
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
lepallpred$conf.low[3] = lepsCI1[1]; lepallpred$conf.high[3] = lepsCI1[2]

##fitted value 4
thetahatsleps = c(lep1pred$predicted[4], lep2pred$predicted[4], lep3pred$predicted[4], lep4pred$predicted[4], 
                  lep5pred$predicted[4], lep6pred$predicted[4], lep7pred$predicted[4], lep8pred$predicted[4])
sethetahatsleps=c(lep1pred$std.error[4], lep2pred$std.error[4], lep3pred$std.error[4], lep4pred$std.error[4], 
                  lep5pred$std.error[4], lep6pred$std.error[4], lep7pred$std.error[4], lep8pred$std.error[4])
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
lepallpred$conf.low[4] = lepsCI1[1]; lepallpred$conf.high[4] = lepsCI1[2]

##fitted value 5
thetahatsleps = c(lep1pred$predicted[5], lep2pred$predicted[5], lep3pred$predicted[5], lep4pred$predicted[5], 
                  lep5pred$predicted[5], lep6pred$predicted[5], lep7pred$predicted[5], lep8pred$predicted[5])
sethetahatsleps=c(lep1pred$std.error[5], lep2pred$std.error[5], lep3pred$std.error[5], lep4pred$std.error[5], 
                  lep5pred$std.error[5], lep6pred$std.error[5], lep7pred$std.error[5], lep8pred$std.error[5])
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
lepallpred$conf.low[5] = lepsCI1[1]; lepallpred$conf.high[5] = lepsCI1[2]

##fitted value 6
thetahatsleps = c(lep1pred$predicted[6], lep2pred$predicted[6], lep3pred$predicted[6], lep4pred$predicted[6], 
                  lep5pred$predicted[6], lep6pred$predicted[6], lep7pred$predicted[6], lep8pred$predicted[6])
sethetahatsleps=c(lep1pred$std.error[6], lep2pred$std.error[6], lep3pred$std.error[6], lep4pred$std.error[6], 
                  lep5pred$std.error[6], lep6pred$std.error[6], lep7pred$std.error[6], lep8pred$std.error[6])
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
lepallpred$conf.low[6] = lepsCI1[1]; lepallpred$conf.high[6] = lepsCI1[2]

##fitted value 7
thetahatsleps = c(lep1pred$predicted[7], lep2pred$predicted[7], lep3pred$predicted[7], lep4pred$predicted[7], 
                  lep5pred$predicted[7], lep6pred$predicted[7], lep7pred$predicted[7], lep8pred$predicted[7])
sethetahatsleps=c(lep1pred$std.error[7], lep2pred$std.error[7], lep3pred$std.error[7], lep4pred$std.error[7], 
                  lep5pred$std.error[7], lep6pred$std.error[7], lep7pred$std.error[7], lep8pred$std.error[7])
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
lepallpred$conf.low[7] = lepsCI1[1]; lepallpred$conf.high[7] = lepsCI1[2]

##fitted value 8
thetahatsleps = c(lep1pred$predicted[8], lep2pred$predicted[8], lep3pred$predicted[8], lep4pred$predicted[8], 
                  lep5pred$predicted[8], lep6pred$predicted[8], lep7pred$predicted[8], lep8pred$predicted[8])
sethetahatsleps=c(lep1pred$std.error[8], lep2pred$std.error[8], lep3pred$std.error[8], lep4pred$std.error[8], 
                  lep5pred$std.error[8], lep6pred$std.error[8], lep7pred$std.error[8], lep8pred$std.error[8])
lepsCI1 = mata.wald(theta.hats = thetahatsleps, se.theta.hats = sethetahatsleps, 
          model.weights = modelweightsleps[c(1:8)], mata.t = FALSE)
lepallpred$conf.low[8] = lepsCI1[1]; lepallpred$conf.high[8] = lepsCI1[2]


############################################## Cal
#first get the model weights
modelweightscals = calmod.crossed_dredge$weight

##fitted value 1
#get the theta hats for the first prediction and the SE of theta hat
thetahatscals = c(cal1pred$predicted[1], cal2pred$predicted[1], cal3pred$predicted[1], cal4pred$predicted[1], 
                  cal5pred$predicted[1], cal6pred$predicted[1], cal7pred$predicted[1], cal8pred$predicted[1])
sethetahatscals=c(cal1pred$std.error[1], cal2pred$std.error[1], cal3pred$std.error[1], cal4pred$std.error[1], 
                  cal5pred$std.error[1], cal6pred$std.error[1], cal7pred$std.error[1], cal8pred$std.error[1])
#run the function
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
#put the values into the big dataframe
calallpred$conf.low[1] = calsCI1[1]; calallpred$conf.high[1] = calsCI1[2]

##fitted value 2
thetahatscals = c(cal1pred$predicted[2], cal2pred$predicted[2], cal3pred$predicted[2], cal4pred$predicted[2], 
                  cal5pred$predicted[2], cal6pred$predicted[2], cal7pred$predicted[2], cal8pred$predicted[2])
sethetahatscals=c(cal1pred$std.error[2], cal2pred$std.error[2], cal3pred$std.error[2], cal4pred$std.error[2], 
                  cal5pred$std.error[2], cal6pred$std.error[2], cal7pred$std.error[2], cal8pred$std.error[2])
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
calallpred$conf.low[2] = calsCI1[1]; calallpred$conf.high[2] = calsCI1[2]

##fitted value 3
thetahatscals = c(cal1pred$predicted[3], cal2pred$predicted[3], cal3pred$predicted[3], cal4pred$predicted[3], 
                  cal5pred$predicted[3], cal6pred$predicted[3], cal7pred$predicted[3], cal8pred$predicted[3])
sethetahatscals=c(cal1pred$std.error[3], cal2pred$std.error[3], cal3pred$std.error[3], cal4pred$std.error[3], 
                  cal5pred$std.error[3], cal6pred$std.error[3], cal7pred$std.error[3], cal8pred$std.error[3])
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
calallpred$conf.low[3] = calsCI1[1]; calallpred$conf.high[3] = calsCI1[2]

##fitted value 4
thetahatscals = c(cal1pred$predicted[4], cal2pred$predicted[4], cal3pred$predicted[4], cal4pred$predicted[4], 
                  cal5pred$predicted[4], cal6pred$predicted[4], cal7pred$predicted[4], cal8pred$predicted[4])
sethetahatscals=c(cal1pred$std.error[4], cal2pred$std.error[4], cal3pred$std.error[4], cal4pred$std.error[4], 
                  cal5pred$std.error[4], cal6pred$std.error[4], cal7pred$std.error[4], cal8pred$std.error[4])
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
calallpred$conf.low[4] = calsCI1[1]; calallpred$conf.high[4] = calsCI1[2]

##fitted value 5
thetahatscals = c(cal1pred$predicted[5], cal2pred$predicted[5], cal3pred$predicted[5], cal4pred$predicted[5], 
                  cal5pred$predicted[5], cal6pred$predicted[5], cal7pred$predicted[5], cal8pred$predicted[5])
sethetahatscals=c(cal1pred$std.error[5], cal2pred$std.error[5], cal3pred$std.error[5], cal4pred$std.error[5], 
                  cal5pred$std.error[5], cal6pred$std.error[5], cal7pred$std.error[5], cal8pred$std.error[5])
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
calallpred$conf.low[5] = calsCI1[1]; calallpred$conf.high[5] = calsCI1[2]

##fitted value 6
thetahatscals = c(cal1pred$predicted[6], cal2pred$predicted[6], cal3pred$predicted[6], cal4pred$predicted[6], 
                  cal5pred$predicted[6], cal6pred$predicted[6], cal7pred$predicted[6], cal8pred$predicted[6])
sethetahatscals=c(cal1pred$std.error[6], cal2pred$std.error[6], cal3pred$std.error[6], cal4pred$std.error[6], 
                  cal5pred$std.error[6], cal6pred$std.error[6], cal7pred$std.error[6], cal8pred$std.error[6])
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
calallpred$conf.low[6] = calsCI1[1]; calallpred$conf.high[6] = calsCI1[2]

##fitted value 7
thetahatscals = c(cal1pred$predicted[7], cal2pred$predicted[7], cal3pred$predicted[7], cal4pred$predicted[7], 
                  cal5pred$predicted[7], cal6pred$predicted[7], cal7pred$predicted[7], cal8pred$predicted[7])
sethetahatscals=c(cal1pred$std.error[7], cal2pred$std.error[7], cal3pred$std.error[7], cal4pred$std.error[7], 
                  cal5pred$std.error[7], cal6pred$std.error[7], cal7pred$std.error[7], cal8pred$std.error[7])
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
calallpred$conf.low[7] = calsCI1[1]; calallpred$conf.high[7] = calsCI1[2]

##fitted value 8
thetahatscals = c(cal1pred$predicted[8], cal2pred$predicted[8], cal3pred$predicted[8], cal4pred$predicted[8], 
                  cal5pred$predicted[8], cal6pred$predicted[8], cal7pred$predicted[8], cal8pred$predicted[8])
sethetahatscals=c(cal1pred$std.error[8], cal2pred$std.error[8], cal3pred$std.error[8], cal4pred$std.error[8], 
                  cal5pred$std.error[8], cal6pred$std.error[8], cal7pred$std.error[8], cal8pred$std.error[8])
calsCI1 = mata.wald(theta.hats = thetahatscals, se.theta.hats = sethetahatscals, 
          model.weights = modelweightscals[c(1:8)], mata.t = FALSE)
calallpred$conf.low[8] = calsCI1[1]; calallpred$conf.high[8] = calsCI1[2]
```

```{r}
#let's try with MuMIn again
#devtools::install_github("glmmTMB/glmmTMB/glmmTMB")
library(glmmTMB)

DI = as.vector(rep('DI', 12)); JS = as.vector(rep('JS', 12))
f = as.vector(rep('2015', 3)); si = as.vector(rep('2016', 3)); sv = as.vector(rep('2017', 3)); e = as.vector(rep('2018', 3))
year = as.vector(cbind(f, si, sv, e)); year = as.vector(replicate(2, year))
CU = 'CU'; PI = 'PI'; SO = 'SO'
spp = as.vector(rbind(CU, PI, SO)); spp = as.vector(replicate(8, spp))

newdata <- matrix(nrow = 24, ncol = 4)
newdata[c(1:12), 1] = DI; newdata[c(13:24), 1] = JS
newdata[c(1:24), 2] = year
newdata[c(1:24), 3] = spp

newdata = data.frame(newdata) 
newdata = newdata %>% 
  rename(site.region = `X1`, year = `X2`, spp = `X3`, collection = `X4`)
newdata$collection = NA
fm1$fit$par[names(fm1$fit$par)=="theta"] <- (-100)
x = predict(lep4, se.fit = TRUE)

lepconfset1 = get.models(lepmod.crossed_dredge, subset = TRUE)
lepmodavg1 = model.avg(lepconfset1, subset = cumsum(weight) <= .95)


leppredict1 = data.frame(
  model = sapply(lepconfset1, predict, newdata = newdata),
  averagedfull = predict(leplist, se.fit = TRUE))
summary(lepconfset1)


data(sleepstudy,package="lme4")
g0 <- glmmTMB(Reaction~Days+(Days|Subject),sleepstudy)
predict(g0, sleepstudy)
## Predict new Subject
nd <- sleepstudy[1,]
nd$Subject <- "new"
predict(g0, newdata=nd, allow.new.levels=TRUE)
## population-level prediction
nd_pop <- data.frame(Days=unique(sleepstudy$Days),
                     Subject=NA)
x = predict(g0, newdata=nd_pop)



n = 20 # 'n' is assumed to be even
x1 = c(rep(0,n/2), rep(1,n/2)) # two groups: x1=0, and x1=1
x2 = rnorm(n, mean=10, sd=3)
y = rnorm(n, mean = 3*x1 + 0.1*x2) # data generation
x1 = factor(x1)
m1 = glm(y ~ x1) # using 'glm' provides AIC values.
m2 = glm(y ~ x1 + x2) # using 'lm' doesn't.
m3 = glm(y ~ x1*x2)
aic = c(m1$aic, m2$aic, m3$aic)
delta.aic = aic - min(aic)
model.weights = exp(-0.5*delta.aic) / sum(exp(-0.5*delta.aic))
residual.dfs = c(m1$df.residual, m2$df.residual, m3$df.residual)
p1 = predict(m1, se=TRUE, newdata=list(x1=factor(1), x2=15))
p2 = predict(m2, se=TRUE, newdata=list(x1=factor(1), x2=15))
p3 = predict(m3, se=TRUE, newdata=list(x1=factor(1), x2=15))
theta.hats = c(p1$fit, p2$fit, p3$fit)
se.theta.hats = c(p1$se.fit, p2$se.fit, p3$se.fit)

theta.hats[1] + c(-1,1)*qt(0.975, residual.dfs[1])*se.theta.hats[1]
theta.hats[2] + c(-1,1)*qt(0.975, residual.dfs[2])*se.theta.hats[2]
theta.hats[3] + c(-1,1)*qt(0.975, residual.dfs[3])*se.theta.hats[3]

x = MATA::mata.wald(theta.hats=theta.hats, se.theta.hats=se.theta.hats,
model.weights=model.weights, mata.t=FALSE)

((3.033905*0.7222926) + (2.658266*0.2777074))

z.quantiles = (theta-theta.hats)/se.theta.hats
tailarea = sum(model.weights*stats::pnorm(z.quantiles)) - alpha
tailarea

3.058910e-01 + c(-1,1)*qt(0.975, 12)*0.3924657

lepmod.crossed_dredge$df

```


## Effects Plots

```{r}
#keep just the averaged predictions and the relevant grouping info 
lepavgpred = lepallpred %>% 
  select(avg, conf.high, conf.low) %>% 
  mutate(sal = lep1pred$x, reg = lep1pred$facet, yr = lep1pred$group)
lepavgpred$sal = factor(lepavgpred$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

calavgpred = calallpred %>% 
  select(avg, conf.high, conf.low) %>% 
  mutate(sal = cal1pred$x, reg = cal1pred$facet, yr = cal1pred$group)
calavgpred$sal = factor(calavgpred$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))




lepmod.crossed.top <- glmmTMB(all.leps ~ spp + site.region + year + site.region * year - 1 + (1 | collection), 
                      data = mainlice, family=nbinom2)
summary(lepmod.crossed.top)
calmod.crossed.top <- glmmTMB(all.cal ~ year + site.region + spp + spp * site.region + 
                            site.region * year + (1 | collection), 
                          data = mainlice, family=nbinom2)
summary(calmod.crossed.top)

lep_top_effects <- ggpredict(lepmod.crossed.top, terms = c('spp', 'year', 'site.region')) #not sure if I did this right
cal_top_effects <- ggpredict(calmod.crossed.top, terms = c('spp', 'year', 'site.region'))

lep_top_effects = lep_top_effects %>% 
  rename(sal = x, reg = facet, yr = group)
cal_top_effects = cal_top_effects %>% 
  rename(sal = x, reg = facet, yr = group)

lep_top_effects$sal = factor(lep_top_effects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))
cal_top_effects$sal = factor(cal_top_effects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

## Make the plots

leg_title <- 'Salmon Species'
lepsfullmodplot_top <- lep_top_effects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "L. salmonis Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
lepsfullmodplot_top
calfullmodplot_top <- cal_top_effects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "C. clemensi Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
calfullmodplot_top
```


So now we need an averaged confidence interval for each of these. To do this, we're going to use model-averaged tail area profile liklihood methods as described by Fletcher & Turek (2012). To do this, we can obtain an approximation to the lower limit of a $(1-2\alpha)100%$ model-averaged profile likelihood interval by finding the value of $\theta_L$ which satisfies $$sum_{i=1}^R p(M_i|y) \Phi(r_i(\theta_L)) = \alpha,$$
where $r_i$ is the signed likelihood ratio statistic defined under model $M_i$ by $$r(\theta) = \mathrm{sign}(\hat{theta}-\theta)sqrt{2(\log(L_p(\hat{theta}))-\log(L_p(\theta))))},$$ using the maximum likelihood estimate $\hat{theta}$ of the parameter $\theta$, and the profile likelihood function for $theta$ given by $$L_p(\theta) = \max_{\lambda}L(\theta,\lambda).$$ In this case, $L(\theta,\lambda)$ is the likelihood function for model $M$ parameterized in terms of $\theta$ and the remaining parameters $\lambda$. In sum, the lower limit of a $(1-2\alpha)100%$ model-averaged profile likelihood interval can by obtained from: $$\sum_{i=1}^R w_i \Phi(r_i(\theta_L)) = \alpha.$$ We can obtain the upper limit by replacing $\alpha$ with $(1-\alpha)$. This 

```{r}
#first thing is to go through and start from the r function and go from there to get all the functions
#use the documented code to assist this

str(lepmod.crossed)
lepmod.crossed$obj

  

```






The signed lielihood ratio is essentially a test statistic. 

```{r}
#example code
### Model 3 l o g???l i k e l i h o o d f u n c t i o n s
# `113.mu` = function(much.b1.b2.b12.logk, xy) {
#   mu.ch=much.b1.b2.b12.logk[1]
#   b1=much.b1.b2.b12.logk[2]
#   b2=much.b1.b2.b12.logk[3]
#   b12=much . b1 . b2 . b12 . l o g k [ 4 ]
#   k=exp(much . b1 . b2 . b12 . l o g k [ 5 ] )
#   mu = mu. ch ??? exp( b1???( xy$x1???xy$x1 . ch )+b2???( xy$x2???xy$x2 . ch )+b12???( xy$x1???xy
#   $x2???xy$x1 . ch???xy$x2 . ch ) )
#   sum(dnbinom( xy$y , s i z e=k , mu=mu, log=T) ) }
# 
# `113.logmu` = function(logmuch . b1 . b2 . b12 . logk , xy ) {
#   mu. ch=exp( logmuch . b1 . b2 . b12 . l o g k [ 1 ] )
#   b1=logmuch . b1 . b2 . b12 . l o g k [ 2 ]
#   b2=logmuch . b1 . b2 . b12 . l o g k [ 3 ]
#   b12=logmuch . b1 . b2 . b12 . l o g k [ 4 ]
#   k=exp( logmuch . b1 . b2 . b12 . l o g k [ 5 ] )
#   mu = mu. ch ??? exp( b1???( xy$x1???xy$x1 . ch )+b2???( xy$x2???xy$x2 . ch )+b12???( xy$x1???xy
#   $x2???xy$x1 . ch???xy$x2 . ch ) )
#   sum(dnbinom( xy$y , s i z e=k , mu=mu, log=T) ) }


```



















```{r}
#this part is trying with MuMIn

#start by getting the models and model averaging the estimates
confleps = get.models(lepmod.crossed_dredge, subset = TRUE, fit = TRUE)
summary(confleps)
lepavg = model.avg(lepmod.crossed_dredge, fit = TRUE)
summary(lepavg)

pred.se = predict(lepavg, type = 'link' , se.fit = TRUE, full = TRUE, newdata)
newdata$fit = pred.se$fit
newdata$upr=newdata$fit+1.96*newdata$SE
newdata$lwr=newdata$fit-1.96*newdata$SE









 #now make a new DF to predict over
nseq <- function(x, len = length(x)) seq(min(x, na.rm = TRUE),
    max(x, na.rm=TRUE), length = len)

DI = as.vector(rep('DI', 12)); JS = as.vector(rep('JS', 12))
f = as.vector(rep('2015', 3)); si = as.vector(rep('2016', 3)); sv = as.vector(rep('2017', 3)); e = as.vector(rep('2018', 3))
year = as.vector(cbind(f, si, sv, e)); year = as.vector(replicate(2, year))
CU = 'CU'; PI = 'PI'; SO = 'SO'
spp = as.vector(rbind(CU, PI, SO)); spp = as.vector(replicate(8, spp))

newdata <- matrix(nrow = 24, ncol = 4)
newdata[c(1:12), 1] = DI; newdata[c(13:24), 1] = JS
newdata[c(1:24), 2] = year
newdata[c(1:24), 3] = spp

newdata = data.frame(newdata) 
newdata = newdata %>% 
  rename(site.region = `X1`, year = `X2`, spp = `X3`, collection = `X4`)


# Predictions from each of the models in a set, and with averaged coefficients
n = length(confleps)
pred <- data.frame(
	model = sapply(confleps, predict, newdata = newdata),
    averaged.full = predict(lepavg, newdata, full = TRUE)
	)



# New predictors: X1 along the range of original data, other
# variables held constant at their means
newdata <- as.data.frame(lapply(lapply(Cement[, -1], mean), rep, 25))
newdata$X1 <- nseq(Cement$X1, nrow(newdata))









calavg = model.avg(calmod.crossed_dredge)
summary(calavg)








calpredict = predict(calavg)
confsetlep = get.models(lepmod.crossed_dredge, subset = TRUE)


lepavg = model.avg(confsetlep)
leppredict = predict(lepavg)
lepavgpred = ggpredict(lepavg, terms = c('site.region', 'year', 'spp'))


y = leppredict




calavg = model.avg(calmod.crossed_dredge)
summary(model.avg(lepmod.crossed_dredge))

#trying the AICcmodavg package
leplist = list(
  glmmTMB(all.leps ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year +
            (1 | collection), data = mainlice, family = nbinom2))

callist = list(
  glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year +
            (1 | collection), data = mainlice, family = nbinom2))
lepavgAIC = modavgPred(leplist)
```

```{r}
data(cement)
# Example from Burnham and Anderson (2002), page 100:
library(lme4)
fm1 <- lm(y ~ x1 + x2 + x3 + x4, data = cement)
summary(fm1)

options(na.action = "na.fail")
ms1 <- MuMIn::dredge(fm1)
confset.95p <- get.models(ms1, subset = cumsum(weight) <= .95)
avgm <- model.avg(confset.95p)

nseq <- function(x, len = length(x)) seq(min(x, na.rm = TRUE),
    max(x, na.rm=TRUE), length = len)

# New predictors: X1 along the range of original data, other
# variables held constant at their means
newdata <- as.data.frame(lapply(lapply(Cement[, -1], mean), rep, 25))
newdata$X1 <- nseq(Cement$X1, nrow(newdata)) 
newdata = newdata %>% 
  rename(x1 = X1, x2 = X2, x3 = X3, x4 = X4)

n <- length(confset.95p)

# Predictions from each of the models in a set, and with averaged coefficients
pred <- data.frame(
	model = sapply(confset.95p, predict, newdata = newdata),
	averaged.subset = predict(avgm, newdata, full = FALSE, se.fit = TRUE),
    averaged.full = predict(avgm, newdata, full = TRUE)
	)
options(na.action = "na.omit")
```

