---
title: "Hakai-Lice-Models-Overview"
author: "Cole"
date: "August 20, 2019"
output:
  html_document:
    df_print: paged
---
#Preliminary Things

I thought this might be the easiest way to show you all the things without having to copy and paste everything into a word document, so here's an RMD instead lol. 

Necessary packages etc:

```{r, echo=FALSE}
#packages
library(tidyverse)
library(glmmTMB)
library(ggeffects)
library(DHARMa)
library(MuMIn)
library(cowplot)
library(AICcmodavg)
library(latexpdf)

#data
mainlice <- read.csv("Hakai_lice_data_CB_edits.csv")

#make vars into factors
mainlice$year <- as.factor(mainlice$year);mainlice$collection <- as.factor(mainlice$collection)
```

#Initial Model Set 

The first set of models from this past school year (region removed from initial model and fit by itself)

## Species Level Models

```{r}
#models and dredge them
lepmodspecies.full <- glmmTMB(all.leps ~ spp + year - 1 + (1|collection), 
                         data = mainlice, family=nbinom2)
calmodspecies.full <- glmmTMB(all.cal ~ spp + year - 1 + (1|collection), 
                         data = mainlice, family=nbinom2)

lepmodspecies.full_dredge = MuMIn::dredge(lepmodspecies.full)
calmodspecies.full_dredge = MuMIn::dredge(calmodspecies.full)
lepmodspecies.full_dredge
calmodspecies.full_dredge

```

## Species Level Effects Plots

```{r}
#effects and plot them

calspecieseffects <- ggpredict(calmodspecies.full, terms = c('spp', 'year'))
lepspecieseffects <- ggpredict(lepmodspecies.full, terms = c('spp', 'year'))

lepspecieseffects = lepspecieseffects %>% 
  rename(sal = x, yr = group)

lepspecieseffects$sal = factor(lepspecieseffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

calspecieseffects = calspecieseffects %>% 
  rename(sal = x, yr = group)

calspecieseffects$sal = factor(calspecieseffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

leg_title <- 'Salmon Species'
lepspeciesfullmodplot <- lepspecieseffects %>% 
  group_by(., yr,sal) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), colour = 'Black')+
  geom_point(size = 4) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2')) +
  labs(title = "L. salmonis Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish')
lepspeciesfullmodplot
calspeciesfullmodplot <- calspecieseffects %>% 
  group_by(., yr,sal) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), colour = 'Black')+
  geom_point(size = 4) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "C. clemensi Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish')
calspeciesfullmodplot
``` 

## Region-Level Models

```{r}
#region-level models
regionlice <- read.csv('Hakai_lice_data_all_fish_CB_edits.csv')

#now lets do it between all three species, by making some sub-dfs first
regionlice$week <- as.factor(regionlice$week); regionlice$year <- as.factor(regionlice$year)
chum.region <- regionlice %>% 
  filter(spp == 'CU')
pink.region <- regionlice %>% 
  filter(spp == 'PI')
sock.region <- regionlice %>% 
  filter(spp == 'SO')

chumrmod.calnb <- glmmTMB(all.cal ~ site.region + year - 1 + (1|week), 
                           data = chum.region, family=nbinom2)
chumrmod.lepsnb <- glmmTMB(all.leps ~ site.region + year - 1 + (1|week), 
                          data = chum.region, family=nbinom2)
pinkrmod.calnb <- glmmTMB(all.cal ~ site.region + year - 1  + (1|week), 
                         data = pink.region, family=nbinom2)
pinkrmod.lepsnb <- glmmTMB(all.leps ~ site.region + year - 1 + (1|week), 
                          data = pink.region, family=nbinom2)
sockrmod.calnb <- glmmTMB(all.cal ~ site.region + year - 1 + (1|week), 
                         data = sock.region, family=nbinom2)
sockrmod.lepsnbsr <- glmmTMB(all.leps ~ site.region - 1 + (1|week), 
                            data = sock.region, family=nbinom2)
summary(chumrmod.calnb); summary(chumrmod.lepsnb); summary(pinkrmod.calnb); summary(pinkrmod.lepsnb); summary(sockrmod.calnb); summary(sockrmod.lepsnbsr)
```

## AIC tables

```{r}
chumcalspeffects <- ggpredict(chumrmod.calnb, terms = c('site.region', 'year'))
chumcalspeffects = chumcalspeffects %>%
  rename(site.region = x, yr = group) %>%
  mutate(lice = 'cal')
chumcalspeffects$site.region = factor(chumcalspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

chumlepspeffects <- ggpredict(chumrmod.lepsnb,terms = c('site.region', 'year'))
chumlepspeffects = chumlepspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'leps')
chumlepspeffects$site.region = factor(chumlepspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

pinkcalspeffects <- ggpredict(pinkrmod.calnb, terms = c('site.region', 'year'))
pinkcalspeffects = pinkcalspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'cal')
pinkcalspeffects$site.region = factor(pinkcalspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

pinklepspeffects <- ggpredict(pinkrmod.lepsnb,terms = c('site.region', 'year'))
pinklepspeffects = pinklepspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'leps')
pinklepspeffects$site.region = factor(pinklepspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

sockcalspeffects <- ggpredict(sockrmod.calnb, terms = c('site.region', 'year'))
sockcalspeffects = sockcalspeffects %>%
  rename(site.region = x, yr = group)%>%
  mutate(lice = 'cal')
sockcalspeffects$site.region = factor(sockcalspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

socklepspeffects <- ggpredict(sockrmod.lepsnbsr,terms = 'site.region')
socklepspeffects = socklepspeffects %>%
  rename(site.region = x)%>%
  mutate(lice = 'leps')
socklepspeffects$site.region = factor(socklepspeffects$site.region, levels = c(1, 2),
                              labels = c('D', 'J'))

chumeffects = rbind(chumcalspeffects, chumlepspeffects)
pinkeffects = rbind(pinkcalspeffects, pinklepspeffects)

```

## Region Level Effects Plots

```{r}
#make some themes so it all looks nice beside each other
fte_themeSock <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_text(size = 10, color = color.axis.text)) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(color="black", size = 0.15)) +
    theme(strip.background = element_blank(),
                  strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = 'none')
}
fte_themeSock2 <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_text(size = 10, color = color.axis.text)) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(color="black", size = 0.15)) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = c(0.9,0.82),
          legend.text = element_text(size = 10),
          legend.title = element_text(size = 10))
}
fte_themeSock3 <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_text(size = 10, color = color.axis.text)) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title,
                                      margin= margin(t = 0.7, r = , b = 0, l = 0, unit = "cm"), vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(color="black", size = 0.15)) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = 'none')
}
fte_themePink <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_blank()) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(linetype = 'dashed', color = 'grey75')) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = 'none')
}
fte_themeChum <- function(){
  color.background = 'white'
  color.grid.major = 'black'
  color.axis.text = 'black'
  color.axis.title = 'black'
  color.title = 'black'
  theme_bw(base_size = 9) +
    theme(panel.background = element_rect(fill=color.background,color = color.background)) +
    theme(plot.background = element_rect(fill = color.background, color = color.background)) +
    theme(panel.border = element_blank()) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(axis.ticks = element_blank()) +
    theme(plot.title = element_text(color = color.title, size = 15, vjust = 1.25)) +
    theme(axis.text.x = element_text(size = 10, color = color.axis.text)) +
    theme(axis.text.y = element_blank()) +
    theme(axis.title.x = element_text(size = 12, color = color.axis.title, vjust = 0)) +
    theme(axis.title.y = element_text(size = 12, color = color.axis.title, vjust = 1.25)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.line.x = element_line(color="black", size = 0.15),
          axis.line.y = element_line(linetype = 'dashed', color = 'grey75')) +
    theme(strip.background = element_blank(),
          strip.placement = 'outside',
          strip.text = element_text(size = 10))+
    theme(legend.position = c(0.8,0.82),
          legend.text = element_text(size = 10),
          legend.title = element_text(size = 10))
}

#make the plots
regionestbyspplotchumnb <- chumeffects %>% 
  group_by(.,lice,site.region,yr) %>% 
  ggplot(aes(x=site.region, y = predicted, colour = site.region, shape = lice)) +
  scale_shape_manual(values = c(17,15),labels = c('C. clemensi','L. salmonis'))+
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high, width = 0), position = position_dodge(width = 0.8),colour = 'Black') +
  geom_point(size = 4, position = position_dodge(width=0.8)) +
  facet_wrap(~yr, nrow=1, strip.position = 'bottom')+
  scale_color_manual(values=c('grey60', 'grey20'))+
  labs(title = "Chum Salmon",x = '', y = NULL,shape = 'Lice Species', colour = 'Region')+
  guides(shape = guide_legend(override.aes = list(shape = c(24,22)), type = 'b'))+
  scale_y_continuous(limits = c(0,1.25)) +
  fte_themeChum()
regionestbyspplotchumnb
regionestbyspplotpinknb <- pinkeffects %>% 
  group_by(.,lice,site.region,yr) %>% 
  ggplot(aes(x=site.region, y = predicted, colour = site.region, shape = lice)) +
  scale_shape_manual(values = c(17,15),labels = c('C. clemensi','L. salmonis'))+
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high, width = 0), position = position_dodge(width = 0.8),colour = 'Black') +
  geom_point(size = 4, position = position_dodge(width=0.8)) +
  facet_wrap(~yr, nrow=1, strip.position = 'bottom')+
  theme(strip.background = element_blank(),strip.placement = 'outside') +
  scale_color_manual(values=c('grey60', 'grey20'))+
  labs(title = "Pink Salmon", x = 'Year & Region', y = NULL,shape = 'Lice Species')+
  guides(shape = guide_legend(override.aes = list(shape = c(24,22)), type = 'b'))+
  scale_y_continuous(limits = c(0,1.25)) +
  fte_themePink()
regionestbyspplotpinknb
regionestbyspplotsockcal <- sockcalspeffects %>% 
  group_by(.,lice,site.region,yr) %>% 
  ggplot(aes(x=site.region, y = predicted, colour = site.region, shape = lice)) +
  scale_shape_manual(values = c(17,15),labels = c('C. clemensi','L. salmonis'))+
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high, width = 0), position = position_dodge(width = 0.8),colour = 'Black') +
  geom_point(size = 4, position = position_dodge(width=0.8)) +
  facet_wrap(~yr, nrow=1, strip.position = 'bottom')+
  theme(strip.background = element_blank(),strip.placement = 'outside') +
  scale_color_manual(values=c('grey60', 'grey20'))+
  labs(title = "Sockeye Salmon", x = '', y = 'Average Number of Motile Lice Per Fish',shape = 'Lice Species')+
  guides(shape = guide_legend(override.aes = list(shape = c(24,22)), type = 'b'))+
  scale_y_continuous(limits = c(0,1.25))+
  fte_themeSock()
regionestbyspplotsockcal

regionbothcalsock <- plot_grid(regionestbyspplotsockcal,regionestbyspplotpinknb,regionestbyspplotchumnb,
                          nrow = 1, labels = NULL, rel_widths = c(1,1,1)) 
regionbothcalsock
```

# New Set of Models

## Models (No Crossed Effects)

```{r}
lepmod.yrsrsp <- glmmTMB(all.leps ~ spp + site.region + year - 1 + (1|collection), 
                      data = mainlice, family=nbinom2)
calmod.yrsrsp <- glmmTMB(all.cal ~ spp + site.region + year - 1 + (1|collection), 
                      data = mainlice, family=nbinom2)
```

## AIC tables

```{r}
lepmod.yrsrsp_dredge = MuMIn::dredge(lepmod.yrsrsp)
calmod.yrsrsp_dredge = MuMIn::dredge(calmod.yrsrsp)
lepmod.yrsrsp_dredge
calmod.yrsrsp_dredge
```

## Effects Plots

```{r}
calspeffects <- ggpredict(calmod.yrsrsp, terms = c('spp', 'year', 'site.region'))
lepspeffects <- ggpredict(lepmod.yrsrsp, terms = c('spp', 'year', 'site.region'))

calspeffects = calspeffects %>% 
  rename(sal = x, reg = facet, yr = group)

calspeffects$sal = factor(calspeffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

lepspeffects = lepspeffects %>% 
  rename(sal = x, reg = facet, yr = group)

lepspeffects$sal = factor(lepspeffects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

## Make the plots

leg_title <- 'Salmon Species'
leps3fullmodplot <- lepspeffects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "L. salmonis Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
leps3fullmodplot
cal3fullmodplot <- calspeffects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "C. clemensi Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
cal3fullmodplot
```

## Models (Crossed Effects)

```{r}
lepmod.crossed <- glmmTMB(all.leps ~ spp * site.region + spp * year + 
                            site.region * year + (1 | collection), 
                          data = mainlice, family=nbinom2)
calmod.crossed <- glmmTMB(all.cal ~ spp * site.region + spp * year + 
                            site.region * year + (1 | collection), 
                          data = mainlice, family=nbinom2)
```

## AIC Tables

```{r}
lepmod.crossed_dredge = MuMIn::dredge(lepmod.crossed, subset = (`cond(site.region)` && `cond(year)`))
lepmod.crossed_dredge
calmod.crossed_dredge = MuMIn::dredge(calmod.crossed, subset = (`cond(site.region)` && `cond(year)`))
calmod.crossed_dredge
```

## Effects Plots

```{r}
lepmod.crossed.top <- glmmTMB(all.leps ~ spp + site.region + year + site.region * year - 1 + (1 | collection), 
                      data = mainlice, family=nbinom2)
summary(lepmod.crossed.top)
calmod.crossed.top <- glmmTMB(all.cal ~ year + site.region + spp + spp * site.region + 
                            site.region * year + (1 | collection), 
                          data = mainlice, family=nbinom2)
summary(calmod.crossed.top)

lep_top_effects <- ggpredict(lepmod.crossed.top, terms = c('spp', 'year', 'site.region')) #not sure if I did this right
cal_top_effects <- ggpredict(calmod.crossed.top, terms = c('spp', 'year', 'site.region'))

lep_top_effects = lep_top_effects %>% 
  rename(sal = x, reg = facet, yr = group)
cal_top_effects = cal_top_effects %>% 
  rename(sal = x, reg = facet, yr = group)

lep_top_effects$sal = factor(lep_top_effects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))
cal_top_effects$sal = factor(cal_top_effects$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

## Make the plots

leg_title <- 'Salmon Species'
lepsfullmodplot_top <- lep_top_effects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "L. salmonis Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
lepsfullmodplot_top
calfullmodplot_top <- cal_top_effects %>% 
  group_by(., yr,sal,reg) %>% 
  ggplot(aes(x = sal, y = predicted, colour = sal, shape = reg)) +
  scale_shape_manual(values = c(15,17)) +
  geom_errorbar(aes(ymin=conf.low, ymax = conf.high,width = 0), position = position_dodge(width = 0.8),colour = 'Black')+
  geom_point(size = 4,position = position_dodge(width = 0.8)) +
  facet_wrap(~yr,nrow=1,strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside") + 
  scale_color_manual(leg_title,values=c('seagreen2', 'hotpink1', 'steelblue2'))+
  labs(title = "C. clemensi Effects Plot", x = 'Salmon Species/Year', y = 'Average Number of Motile Lice Per Fish') +
  guides(shape = guide_legend(title = 'Region', override.aes = list(shape = c(0,2)), type = 'b'))
calfullmodplot_top

```

# Model Averaging

So the goal here is to hard code all of this, starting with the model-averaged predictions and then the confidence intervals. 

For the predictions, we have the set of $R$ candidate models ${M_1,...,M_n}$ models and we want the model-averaged estimator $\hat{theta}$ of $\theta$ as the weighted average from each model$$\hat{theta} = \sum_{i=1}^R \w_i\hat{theta}$$. This can be used to average the predictions that we get using the ggpredict package. 

First we need all our candidate models - for simplicity sake they've been organized by the ranking from the model comparison. 

```{r}
#omited the last two models in each set since their weights were 0. 
lep1 = glmmTMB(all.leps ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep2 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep3 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep4 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep5 = glmmTMB(all.leps ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep6 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year +  
            (1 | collection), data = mainlice, family = nbinom2) 
lep7 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + 
            (1 | collection), data = mainlice, family = nbinom2) 
lep8 = glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2) 



cal1 = glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year + site.region * spp +
            (1 | collection), data = mainlice, family = nbinom2) 
cal2 = glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal3 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + site.region * year + spp * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal4 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2)
cal5 = glmmTMB(all.cal ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal6 = glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year +  
            (1 | collection), data = mainlice, family = nbinom2)
cal7 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year + 
            (1 | collection), data = mainlice, family = nbinom2) 
cal8 = glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2) 
```

Now let's use the ggpredict package to get predictions with confidence intervals:

```{r}
lep1pred <- ggpredict(lep1, terms = c('spp', 'year', 'site.region'))
lep2pred <- ggpredict(lep2, terms = c('spp', 'year', 'site.region')) 
lep3pred <- ggpredict(lep3, terms = c('spp', 'year', 'site.region')) 
lep4pred <- ggpredict(lep4, terms = c('spp', 'year', 'site.region')) 
lep5pred <- ggpredict(lep5, terms = c('spp', 'year', 'site.region')) 
lep6pred <- ggpredict(lep6, terms = c('spp', 'year', 'site.region')) 
lep7pred <- ggpredict(lep7, terms = c('spp', 'year', 'site.region')) 
lep8pred <- ggpredict(lep8, terms = c('spp', 'year', 'site.region')) 

cal1pred <- ggpredict(cal1, terms = c('spp', 'year', 'site.region'))
cal2pred <- ggpredict(cal2, terms = c('spp', 'year', 'site.region')) 
cal3pred <- ggpredict(cal3, terms = c('spp', 'year', 'site.region')) 
cal4pred <- ggpredict(cal4, terms = c('spp', 'year', 'site.region')) 
cal5pred <- ggpredict(cal5, terms = c('spp', 'year', 'site.region')) 
cal6pred <- ggpredict(cal6, terms = c('spp', 'year', 'site.region')) 
cal7pred <- ggpredict(cal7, terms = c('spp', 'year', 'site.region')) 
cal8pred <- ggpredict(cal8, terms = c('spp', 'year', 'site.region')) 

```

So now that we have the predictions, we can use the weights to get model averaged results for each. 

```{r}
###start by getting them all in one dataframe with the weights

#pull the predicted values from each one
lepallpred = data.frame(cbind(lep1pred$predicted, lep2pred$predicted, lep3pred$predicted, lep4pred$predicted,
                   lep5pred$predicted, lep6pred$predicted, lep7pred$predicted, lep8pred$predicted)) %>% 
                  rename(lep1 = X1, lep2 = X2, lep3 = X3, lep4 = X4, lep5 = X5, lep6 = X6, lep7 = X7, lep8 = X8)
calallpred = data.frame(cbind(cal1pred$predicted, cal2pred$predicted, cal3pred$predicted, cal4pred$predicted,
                   cal5pred$predicted, cal6pred$predicted, cal7pred$predicted, cal8pred$predicted)) %>% 
                  rename(cal1 = X1, cal2 = X2, cal3 = X3, cal4 = X4, cal5 = X5, cal6 = X6, cal7 = X7, cal8 = X8)

#add the weights from the model selection object
lepallpred = lepallpred %>% 
  mutate(w1 = rep(lepmod.crossed_dredge$weight[1], nrow(lepallpred)), 
         w2 = rep(lepmod.crossed_dredge$weight[2], nrow(lepallpred)),
         w3 = rep(lepmod.crossed_dredge$weight[3], nrow(lepallpred)),
         w4 = rep(lepmod.crossed_dredge$weight[4], nrow(lepallpred)),
         w5 = rep(lepmod.crossed_dredge$weight[5], nrow(lepallpred)),
         w6 = rep(lepmod.crossed_dredge$weight[6], nrow(lepallpred)),
         w7 = rep(lepmod.crossed_dredge$weight[7], nrow(lepallpred)),
         w8 = rep(lepmod.crossed_dredge$weight[8], nrow(lepallpred)))

calallpred = calallpred %>% 
  mutate(w1 = rep(calmod.crossed_dredge$weight[1], nrow(calallpred)), 
         w2 = rep(calmod.crossed_dredge$weight[2], nrow(calallpred)),
         w3 = rep(calmod.crossed_dredge$weight[3], nrow(calallpred)),
         w4 = rep(calmod.crossed_dredge$weight[4], nrow(calallpred)),
         w5 = rep(calmod.crossed_dredge$weight[5], nrow(calallpred)),
         w6 = rep(calmod.crossed_dredge$weight[6], nrow(calallpred)),
         w7 = rep(calmod.crossed_dredge$weight[7], nrow(calallpred)),
         w8 = rep(calmod.crossed_dredge$weight[8], nrow(calallpred)))

#now make averaged predictions!
lepallpred = lepallpred %>% 
  mutate(lep1w = lep1*w1, lep2w = lep2*w2, lep3w = lep3*w3, lep4w = lep4*w4, lep5w = lep5*w5, lep6w = lep6*w6, lep7w = lep7*w7, lep8w = lep8*w8) %>% 
  mutate(avg = lep1w + lep2w + lep3w + lep4w + lep5w + lep6w + lep7w + lep8w)

calallpred = calallpred %>% 
  mutate(cal1w = cal1*w1, cal2w = cal2*w2, cal3w = cal3*w3, cal4w = cal4*w4, cal5w = cal5*w5, cal6w = cal6*w6, cal7w = cal7*w7, cal8w = cal8*w8) %>% 
  mutate(avg = cal1w + cal2w + cal3w + cal4w + cal5w + cal6w + cal7w + cal8w)

#keep just the averaged predictions and the relevant grouping info 
lepavgpred = lepallpred %>% 
  select(avg) %>% 
  mutate(sal = lep1pred$x, reg = lep1pred$facet, yr = lep1pred$group)
lepavgpred$sal = factor(lepavgpred$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))

calavgpred = calallpred %>% 
  select(avg) %>% 
  mutate(sal = cal1pred$x, reg = cal1pred$facet, yr = cal1pred$group)
calavgpred$sal = factor(calavgpred$sal, levels = c(1, 2, 3), labels = c('CU', 'PI', 'SO'))
```

So now we need an averaged confidence interval for each of these. To do this, we're going to use model-averaged tail area profile liklihood methods as described by Fletcher & Turek (2012). To do this, we can obtain an approximation to the lower limit of a $(1-2\alpha)100%$ model-averaged profile likelihood interval by finding the value of $\theta_L$ which satisfies $$sum_{i=1}^R p(M_i|y) \Phi(r_i(\theta_L)) = \alpha,$$
where $r_i$ is the signed likelihood ratio statistic defined under model $M_i$ by $$r(\theta) = \mathrm{sign}(\hat{theta}-\theta)sqrt{2(\log(L_p(\hat{theta}))-\log(L_p(\theta))))},$$ using the maximum likelihood estimate $\hat{theta}$ of the parameter $\theta$, and the profile likelihood function for $theta$ given by $$L_p(\theta) = \max_{\lambda}L(\theta,\lambda).$$ In this case, $L(\theta,\lambda)$ is the likelihood function for model $M$ parameterized in terms of $\theta$ and the remaining parameters $\lambda$. In sum, the lower limit of a $(1-2\alpha)100%$ model-averaged profile likelihood interval can by obtained from: $$\sum_{i=1}^R w_i \Phi(r_i(\theta_L)) = \alpha.$$ We can obtain the upper limit by replacing $\alpha$ with $(1-\alpha)$. This 

```{r}
#first thing is to go through and start from the r function and go from there to get all the functions
#use the documented code to assist this

str(lepmod.crossed)
lepmod.crossed$obj

  

```






The signed lielihood ratio is essentially a test statistic. 

```{r}
#example code
### Model 3 l o g-l i k e l i h o o d f u n c t i o n s
# `113.mu` = function(much.b1.b2.b12.logk, xy) {
#   mu.ch=much.b1.b2.b12.logk[1]
#   b1=much.b1.b2.b12.logk[2]
#   b2=much.b1.b2.b12.logk[3]
#   b12=much . b1 . b2 . b12 . l o g k [ 4 ]
#   k=exp(much . b1 . b2 . b12 . l o g k [ 5 ] )
#   mu = mu. ch * exp( b1*( xy$x1-xy$x1 . ch )+b2*( xy$x2-xy$x2 . ch )+b12*( xy$x1*xy
#   $x2-xy$x1 . ch*xy$x2 . ch ) )
#   sum(dnbinom( xy$y , s i z e=k , mu=mu, log=T) ) }
# 
# `113.logmu` = function(logmuch . b1 . b2 . b12 . logk , xy ) {
#   mu. ch=exp( logmuch . b1 . b2 . b12 . l o g k [ 1 ] )
#   b1=logmuch . b1 . b2 . b12 . l o g k [ 2 ]
#   b2=logmuch . b1 . b2 . b12 . l o g k [ 3 ]
#   b12=logmuch . b1 . b2 . b12 . l o g k [ 4 ]
#   k=exp( logmuch . b1 . b2 . b12 . l o g k [ 5 ] )
#   mu = mu. ch * exp( b1*( xy$x1-xy$x1 . ch )+b2*( xy$x2-xy$x2 . ch )+b12*( xy$x1*xy
#   $x2-xy$x1 . ch*xy$x2 . ch ) )
#   sum(dnbinom( xy$y , s i z e=k , mu=mu, log=T) ) }


```



















```{r}
#this part is trying with MuMIn

#start by getting the models and model averaging the estimates
confleps = get.models(lepmod.crossed_dredge, subset = TRUE, fit = TRUE)
summary(confleps)
lepavg = model.avg(lepmod.crossed_dredge, fit = TRUE)
summary(lepavg)

pred.se = predict(lepavg, type = 'link' , se.fit = TRUE, full = TRUE, newdata)
newdata$fit = pred.se$fit
newdata$upr=newdata$fit+1.96*newdata$SE
newdata$lwr=newdata$fit-1.96*newdata$SE









 #now make a new DF to predict over
nseq <- function(x, len = length(x)) seq(min(x, na.rm = TRUE),
    max(x, na.rm=TRUE), length = len)

DI = as.vector(rep('DI', 12)); JS = as.vector(rep('JS', 12))
f = as.vector(rep('2015', 3)); si = as.vector(rep('2016', 3)); sv = as.vector(rep('2017', 3)); e = as.vector(rep('2018', 3))
year = as.vector(cbind(f, si, sv, e)); year = as.vector(replicate(2, year))
CU = 'CU'; PI = 'PI'; SO = 'SO'
spp = as.vector(rbind(CU, PI, SO)); spp = as.vector(replicate(8, spp))

newdata <- matrix(nrow = 24, ncol = 4)
newdata[c(1:12), 1] = DI; newdata[c(13:24), 1] = JS
newdata[c(1:24), 2] = year
newdata[c(1:24), 3] = spp

newdata = data.frame(newdata) 
newdata = newdata %>% 
  rename(site.region = `X1`, year = `X2`, spp = `X3`, collection = `X4`)


# Predictions from each of the models in a set, and with averaged coefficients
n = length(confleps)
pred <- data.frame(
	model = sapply(confleps, predict, newdata = newdata),
    averaged.full = predict(lepavg, newdata, full = TRUE)
	)



# New predictors: X1 along the range of original data, other
# variables held constant at their means
newdata <- as.data.frame(lapply(lapply(Cement[, -1], mean), rep, 25))
newdata$X1 <- nseq(Cement$X1, nrow(newdata))









calavg = model.avg(calmod.crossed_dredge)
summary(calavg)








calpredict = predict(calavg)
confsetlep = get.models(lepmod.crossed_dredge, subset = TRUE)


lepavg = model.avg(confsetlep)
leppredict = predict(lepavg)
lepavgpred = ggpredict(lepavg, terms = c('site.region', 'year', 'spp'))


y = leppredict




calavg = model.avg(calmod.crossed_dredge)
summary(model.avg(lepmod.crossed_dredge))

#trying the AICcmodavg package
leplist = list(
  glmmTMB(all.leps ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.leps ~ site.region + year +
            (1 | collection), data = mainlice, family = nbinom2))

callist = list(
  glmmTMB(all.cal ~ site.region + year + spp + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + spp * year + site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + spp + 
            spp * site.region + spp * year +  
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year + 
            site.region * year + 
            (1 | collection), data = mainlice, family = nbinom2), 
  glmmTMB(all.cal ~ site.region + year +
            (1 | collection), data = mainlice, family = nbinom2))
lepavgAIC = modavgPred(leplist)
```

```{r}
data(cement)
# Example from Burnham and Anderson (2002), page 100:
library(lme4)
fm1 <- lm(y ~ x1 + x2 + x3 + x4, data = cement)
summary(fm1)

options(na.action = "na.fail")
ms1 <- MuMIn::dredge(fm1)
confset.95p <- get.models(ms1, subset = cumsum(weight) <= .95)
avgm <- model.avg(confset.95p)

nseq <- function(x, len = length(x)) seq(min(x, na.rm = TRUE),
    max(x, na.rm=TRUE), length = len)

# New predictors: X1 along the range of original data, other
# variables held constant at their means
newdata <- as.data.frame(lapply(lapply(Cement[, -1], mean), rep, 25))
newdata$X1 <- nseq(Cement$X1, nrow(newdata)) 
newdata = newdata %>% 
  rename(x1 = X1, x2 = X2, x3 = X3, x4 = X4)

n <- length(confset.95p)

# Predictions from each of the models in a set, and with averaged coefficients
pred <- data.frame(
	model = sapply(confset.95p, predict, newdata = newdata),
	averaged.subset = predict(avgm, newdata, full = FALSE, se.fit = TRUE),
    averaged.full = predict(avgm, newdata, full = TRUE)
	)
options(na.action = "na.omit")
```

